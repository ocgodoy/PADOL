"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = ReactSearchAutocomplete;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _fuse = _interopRequireDefault(require("fuse.js"));

var _defaults = require("./defaults/defaults");

var _Results = _interopRequireDefault(require("./Results/Results"));

var _StyledReactSearchAutocomplete = require("./StyledReactSearchAutocomplete");

var _SearchInput = _interopRequireDefault(require("./SearchInput/SearchInput"));

var _styledComponents = require("styled-components");

var _utils = require("./utils/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { if (typeof Symbol === "undefined" || !(Symbol.iterator in Object(arr))) return; var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function ReactSearchAutocomplete(props) {
  var items = props.items,
      fuseOptions = props.fuseOptions,
      useCaching = props.useCaching,
      inputDebounce = props.inputDebounce,
      onSearch = props.onSearch,
      onSelect = props.onSelect,
      onFocus = props.onFocus,
      showIcon = props.showIcon,
      maxResults = props.maxResults,
      placeholder = props.placeholder,
      autoFocus = props.autoFocus,
      styling = props.styling,
      resultStringKeyName = props.resultStringKeyName;

  var theme = _objectSpread(_objectSpread({}, _defaults.defaultTheme), styling);

  var options = _objectSpread(_objectSpread({}, _defaults.defaultFuseOptions), fuseOptions);

  var _React$useState = _react["default"].useState(''),
      _React$useState2 = _slicedToArray(_React$useState, 2),
      searchString = _React$useState2[0],
      setSearchString = _React$useState2[1];

  var _React$useState3 = _react["default"].useState(),
      _React$useState4 = _slicedToArray(_React$useState3, 2),
      results = _React$useState4[0],
      setResults = _React$useState4[1];

  _react["default"].useEffect(function () {
    if (useCaching) sessionStorage.clear();
  }, [items]);

  _react["default"].useEffect(function () {
    var keyword = searchString === null || searchString === void 0 ? void 0 : searchString.toLowerCase();

    if ((keyword === null || keyword === void 0 ? void 0 : keyword.length) > 0) {
      var fuse = new _fuse["default"](items, options);
      var newResults = fuse.search(searchString).map(function (result) {
        return _objectSpread({}, result.item);
      });

      if (useCaching) {
        if (keyword in sessionStorage) {
          setResults(JSON.parse(sessionStorage.getItem(keyword)));
        } else {
          sessionStorage.setItem(keyword, JSON.stringify(newResults));
          setResults(newResults);
        }
      } else {
        setResults(newResults);
      }
    } else {
      setResults([]);
    }
  }, [searchString, items, useCaching]); // This is used to debounce the onSearch props function


  var debounceOnSearch = _react["default"].useCallback(inputDebounce > 0 ? (0, _utils.debounce)(function (keyword, cached) {
    return onSearch(keyword, cached);
  }, inputDebounce) : function (keyword, cached) {
    return onSearch(keyword, cached);
  }, []);

  var handleSetSearchString = function handleSetSearchString(event) {
    setSearchString(event.target.value);
    var keyword = event.target.value.toLowerCase();

    if (useCaching) {
      onSearch && debounceOnSearch(event.target.value, (0, _utils.isCached)(keyword));
    } else {
      onSearch && debounceOnSearch(event.target.value, false);
    }
  };

  return /*#__PURE__*/_react["default"].createElement(_styledComponents.ThemeProvider, {
    theme: theme
  }, /*#__PURE__*/_react["default"].createElement(_defaults.GlobalStyle, null), /*#__PURE__*/_react["default"].createElement(_StyledReactSearchAutocomplete.StyledReactSearchAutocomplete, null, /*#__PURE__*/_react["default"].createElement("div", {
    className: "wrapper"
  }, /*#__PURE__*/_react["default"].createElement(_SearchInput["default"], {
    searchString: searchString,
    setSearchString: handleSetSearchString,
    autoFocus: autoFocus,
    onBlur: function onBlur() {
      return setResults([]);
    },
    onFocus: onFocus,
    placeholder: placeholder,
    showIcon: showIcon
  }), /*#__PURE__*/_react["default"].createElement(_Results["default"], {
    results: results,
    onClick: onSelect,
    setSearchString: setSearchString,
    showIcon: showIcon,
    maxResults: maxResults,
    resultStringKeyName: resultStringKeyName
  }))));
}

ReactSearchAutocomplete.defaultProps = {
  items: [],
  fuseOptions: _defaults.defaultFuseOptions,
  useCaching: false,
  inputDebounce: 200,
  showIcon: true,
  maxResults: 10,
  placeholder: '',
  autoFocus: false,
  styling: {},
  resultStringKeyName: 'name'
};
ReactSearchAutocomplete.propTypes = {
  items: _propTypes["default"].array,
  fuseOptions: _propTypes["default"].object,
  useCaching: _propTypes["default"].bool,
  inputDebounce: _propTypes["default"].number,
  onSearch: _propTypes["default"].func,
  onSelect: _propTypes["default"].func,
  onFocus: _propTypes["default"].func,
  showIcon: _propTypes["default"].bool,
  maxResults: _propTypes["default"].number,
  placeholder: _propTypes["default"].string,
  autoFocus: _propTypes["default"].bool,
  styling: _propTypes["default"].object,
  resultStringKeyName: _propTypes["default"].string
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SZWFjdFNlYXJjaEF1dG9jb21wbGV0ZS5qcyJdLCJuYW1lcyI6WyJSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZSIsInByb3BzIiwiaXRlbXMiLCJmdXNlT3B0aW9ucyIsInVzZUNhY2hpbmciLCJpbnB1dERlYm91bmNlIiwib25TZWFyY2giLCJvblNlbGVjdCIsIm9uRm9jdXMiLCJzaG93SWNvbiIsIm1heFJlc3VsdHMiLCJwbGFjZWhvbGRlciIsImF1dG9Gb2N1cyIsInN0eWxpbmciLCJyZXN1bHRTdHJpbmdLZXlOYW1lIiwidGhlbWUiLCJkZWZhdWx0VGhlbWUiLCJvcHRpb25zIiwiZGVmYXVsdEZ1c2VPcHRpb25zIiwiUmVhY3QiLCJ1c2VTdGF0ZSIsInNlYXJjaFN0cmluZyIsInNldFNlYXJjaFN0cmluZyIsInJlc3VsdHMiLCJzZXRSZXN1bHRzIiwidXNlRWZmZWN0Iiwic2Vzc2lvblN0b3JhZ2UiLCJjbGVhciIsImtleXdvcmQiLCJ0b0xvd2VyQ2FzZSIsImxlbmd0aCIsImZ1c2UiLCJGdXNlIiwibmV3UmVzdWx0cyIsInNlYXJjaCIsIm1hcCIsInJlc3VsdCIsIml0ZW0iLCJKU09OIiwicGFyc2UiLCJnZXRJdGVtIiwic2V0SXRlbSIsInN0cmluZ2lmeSIsImRlYm91bmNlT25TZWFyY2giLCJ1c2VDYWxsYmFjayIsImNhY2hlZCIsImhhbmRsZVNldFNlYXJjaFN0cmluZyIsImV2ZW50IiwidGFyZ2V0IiwidmFsdWUiLCJkZWZhdWx0UHJvcHMiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJhcnJheSIsIm9iamVjdCIsImJvb2wiLCJudW1iZXIiLCJmdW5jIiwic3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFZSxTQUFTQSx1QkFBVCxDQUFpQ0MsS0FBakMsRUFBd0M7QUFBQSxNQUVuREMsS0FGbUQs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RUFBQUEsUUFBUSxFQUFFNkMsc0JBQVVLLElBTmM7QUFPbENqRCxFQUFBQSxPQUFPLEVBQUU0QyxzQkFBVUssSUFQZTtBQVFsQ2hELEVBQUFBLFFBQVEsRUFBRTJDLHNCQUFVRyxJQVJjO0FBU2xDN0MsRUFBQUEsVUFBVSxFQUFFMEMsc0JBQVVJLE1BVFk7QUFVbEM3QyxFQUFBQSxXQUFXLEVBQUV5QyxzQkFBVU0sTUFWVztBQVdsQzlDLEVBQUFBLFNBQVMsRUFBRXdDLHNCQUFVRyxJQVhhO0FBWWxDMUMsRUFBQUEsT0FBTyxFQUFFdUMsc0JBQVVFLE1BWmU7QUFhbEN4QyxFQUFBQSxtQkFBbUIsRUFBRXNDLHNCQUFVTTtBQWJHLENBQXBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IEZ1c2UgZnJvbSAnZnVzZS5qcydcbmltcG9ydCB7IGRlZmF1bHRUaGVtZSwgR2xvYmFsU3R5bGUsIGRlZmF1bHRGdXNlT3B0aW9ucyB9IGZyb20gJy4vZGVmYXVsdHMvZGVmYXVsdHMnXG5pbXBvcnQgUmVzdWx0cyBmcm9tICcuL1Jlc3VsdHMvUmVzdWx0cydcbmltcG9ydCB7IFN0eWxlZFJlYWN0U2VhcmNoQXV0b2NvbXBsZXRlIH0gZnJvbSAnLi9TdHlsZWRSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZSdcbmltcG9ydCBTZWFyY2hJbnB1dCBmcm9tICcuL1NlYXJjaElucHV0L1NlYXJjaElucHV0J1xuaW1wb3J0IHsgVGhlbWVQcm92aWRlciB9IGZyb20gJ3N0eWxlZC1jb21wb25lbnRzJ1xuaW1wb3J0IHsgZGVib3VuY2UsIGlzQ2FjaGVkIH0gZnJvbSAnLi91dGlscy91dGlscydcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gUmVhY3RTZWFyY2hBdXRvY29tcGxldGUocHJvcHMpIHtcbiAgY29uc3Qge1xuICAgIGl0ZW1zLFxuICAgIGZ1c2VPcHRpb25zLFxuICAgIHVzZUNhY2hpbmcsXG4gICAgaW5wdXREZWJvdW5jZSxcbiAgICBvblNlYXJjaCxcbiAgICBvblNlbGVjdCxcbiAgICBvbkZvY3VzLFxuICAgIHNob3dJY29uLFxuICAgIG1heFJlc3VsdHMsXG4gICAgcGxhY2Vob2xkZXIsXG4gICAgYXV0b0ZvY3VzLFxuICAgIHN0eWxpbmcsXG4gICAgcmVzdWx0U3RyaW5nS2V5TmFtZVxuICB9ID0gcHJvcHNcblxuICBjb25zdCB0aGVtZSA9IHsgLi4uZGVmYXVsdFRoZW1lLCAuLi5zdHlsaW5nIH1cbiAgY29uc3Qgb3B0aW9ucyA9IHsgLi4uZGVmYXVsdEZ1c2VPcHRpb25zLCAuLi5mdXNlT3B0aW9ucyB9XG5cbiAgY29uc3QgW3NlYXJjaFN0cmluZywgc2V0U2VhcmNoU3RyaW5nXSA9IFJlYWN0LnVzZVN0YXRlKCcnKVxuICBjb25zdCBbcmVzdWx0cywgc2V0UmVzdWx0c10gPSBSZWFjdC51c2VTdGF0ZSgpXG5cbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAodXNlQ2FjaGluZykgc2Vzc2lvblN0b3JhZ2UuY2xlYXIoKVxuICB9LCBbaXRlbXNdKVxuXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgY29uc3Qga2V5d29yZCA9IHNlYXJjaFN0cmluZz8udG9Mb3dlckNhc2UoKVxuXG4gICAgaWYgKGtleXdvcmQ/Lmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGZ1c2UgPSBuZXcgRnVzZShpdGVtcywgb3B0aW9ucylcbiAgICAgIGNvbnN0IG5ld1Jlc3VsdHMgPSBmdXNlLnNlYXJjaChzZWFyY2hTdHJpbmcpLm1hcCgocmVzdWx0KSA9PiAoeyAuLi5yZXN1bHQuaXRlbSB9KSlcblxuICAgICAgaWYgKHVzZUNhY2hpbmcpIHtcbiAgICAgICAgaWYgKGtleXdvcmQgaW4gc2Vzc2lvblN0b3JhZ2UpIHtcbiAgICAgICAgICBzZXRSZXN1bHRzKEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShrZXl3b3JkKSkpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShrZXl3b3JkLCBKU09OLnN0cmluZ2lmeShuZXdSZXN1bHRzKSlcbiAgICAgICAgICBzZXRSZXN1bHRzKG5ld1Jlc3VsdHMpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNldFJlc3VsdHMobmV3UmVzdWx0cylcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgc2V0UmVzdWx0cyhbXSlcbiAgICB9XG4gIH0sIFtzZWFyY2hTdHJpbmcsIGl0ZW1zLCB1c2VDYWNoaW5nXSlcblxuICAvLyBUaGlzIGlzIHVzZWQgdG8gZGVib3VuY2UgdGhlIG9uU2VhcmNoIHByb3BzIGZ1bmN0aW9uXG4gIGNvbnN0IGRlYm91bmNlT25TZWFyY2ggPSBSZWFjdC51c2VDYWxsYmFjayhcbiAgICBpbnB1dERlYm91bmNlID4gMFxuICAgICAgPyBkZWJvdW5jZSgoa2V5d29yZCwgY2FjaGVkKSA9PiBvblNlYXJjaChrZXl3b3JkLCBjYWNoZWQpLCBpbnB1dERlYm91bmNlKVxuICAgICAgOiAoa2V5d29yZCwgY2FjaGVkKSA9PiBvblNlYXJjaChrZXl3b3JkLCBjYWNoZWQpLFxuICAgIFtdXG4gIClcblxuICBjb25zdCBoYW5kbGVTZXRTZWFyY2hTdHJpbmcgPSAoZXZlbnQpID0+IHtcbiAgICBzZXRTZWFyY2hTdHJpbmcoZXZlbnQudGFyZ2V0LnZhbHVlKVxuICAgIGNvbnN0IGtleXdvcmQgPSBldmVudC50YXJnZXQudmFsdWUudG9Mb3dlckNhc2UoKVxuICAgIGlmICh1c2VDYWNoaW5nKSB7XG4gICAgICBvblNlYXJjaCAmJiBkZWJvdW5jZU9uU2VhcmNoKGV2ZW50LnRhcmdldC52YWx1ZSwgaXNDYWNoZWQoa2V5d29yZCkpXG4gICAgfSBlbHNlIHtcbiAgICAgIG9uU2VhcmNoICYmIGRlYm91bmNlT25TZWFyY2goZXZlbnQudGFyZ2V0LnZhbHVlLCBmYWxzZSlcbiAgICB9XG4gIH1cblxuICByZXR1cm4gKFxuICAgIDxUaGVtZVByb3ZpZGVyIHRoZW1lPXt0aGVtZX0+XG4gICAgICA8R2xvYmFsU3R5bGUgLz5cbiAgICAgIDxTdHlsZWRSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZT5cbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJ3cmFwcGVyXCI+XG4gICAgICAgICAgPFNlYXJjaElucHV0XG4gICAgICAgICAgICBzZWFyY2hTdHJpbmc9e3NlYXJjaFN0cmluZ31cbiAgICAgICAgICAgIHNldFNlYXJjaFN0cmluZz17aGFuZGxlU2V0U2VhcmNoU3RyaW5nfVxuICAgICAgICAgICAgYXV0b0ZvY3VzPXthdXRvRm9jdXN9XG4gICAgICAgICAgICBvbkJsdXI9eygpID0+IHNldFJlc3VsdHMoW10pfVxuICAgICAgICAgICAgb25Gb2N1cz17b25Gb2N1c31cbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtwbGFjZWhvbGRlcn1cbiAgICAgICAgICAgIHNob3dJY29uPXtzaG93SWNvbn1cbiAgICAgICAgICAvPlxuICAgICAgICAgIDxSZXN1bHRzXG4gICAgICAgICAgICByZXN1bHRzPXtyZXN1bHRzfVxuICAgICAgICAgICAgb25DbGljaz17b25TZWxlY3R9XG4gICAgICAgICAgICBzZXRTZWFyY2hTdHJpbmc9e3NldFNlYXJjaFN0cmluZ31cbiAgICAgICAgICAgIHNob3dJY29uPXtzaG93SWNvbn1cbiAgICAgICAgICAgIG1heFJlc3VsdHM9e21heFJlc3VsdHN9XG4gICAgICAgICAgICByZXN1bHRTdHJpbmdLZXlOYW1lPXtyZXN1bHRTdHJpbmdLZXlOYW1lfVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9TdHlsZWRSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZT5cbiAgICA8L1RoZW1lUHJvdmlkZXI+XG4gIClcbn1cblxuUmVhY3RTZWFyY2hBdXRvY29tcGxldGUuZGVmYXVsdFByb3BzID0ge1xuICBpdGVtczogW10sXG4gIGZ1c2VPcHRpb25zOiBkZWZhdWx0RnVzZU9wdGlvbnMsXG4gIHVzZUNhY2hpbmc6IGZhbHNlLFxuICBpbnB1dERlYm91bmNlOiAyMDAsXG4gIHNob3dJY29uOiB0cnVlLFxuICBtYXhSZXN1bHRzOiAxMCxcbiAgcGxhY2Vob2xkZXI6ICcnLFxuICBhdXRvRm9jdXM6IGZhbHNlLFxuICBzdHlsaW5nOiB7fSxcbiAgcmVzdWx0U3RyaW5nS2V5TmFtZTogJ25hbWUnXG59XG5cblJlYWN0U2VhcmNoQXV0b2NvbXBsZXRlLnByb3BUeXBlcyA9IHtcbiAgaXRlbXM6IFByb3BUeXBlcy5hcnJheSxcbiAgZnVzZU9wdGlvbnM6IFByb3BUeXBlcy5vYmplY3QsXG4gIHVzZUNhY2hpbmc6IFByb3BUeXBlcy5ib29sLFxuICBpbnB1dERlYm91bmNlOiBQcm9wVHlwZXMubnVtYmVyLFxuICBvblNlYXJjaDogUHJvcFR5cGVzLmZ1bmMsXG4gIG9uU2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgb25Gb2N1czogUHJvcFR5cGVzLmZ1bmMsXG4gIHNob3dJY29uOiBQcm9wVHlwZXMuYm9vbCxcbiAgbWF4UmVzdWx0czogUHJvcFR5cGVzLm51bWJlcixcbiAgcGxhY2Vob2xkZXI6IFByb3BUeXBlcy5zdHJpbmcsXG4gIGF1dG9Gb2N1czogUHJvcFR5cGVzLmJvb2wsXG4gIHN0eWxpbmc6IFByb3BUeXBlcy5vYmplY3QsXG4gIHJlc3VsdFN0cmluZ0tleU5hbWU6IFByb3BUeXBlcy5zdHJpbmdcbn1cbiJdfQ==